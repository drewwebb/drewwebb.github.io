<script>
  const params   = new URLSearchParams(location.search);
  const id       = params.get('id');                 // advanced path (stored submission)
  const isGuest  = params.get('guest') === '1';
  const nameQP   = params.get('name');               // simple path (no storage)
  const emailQP  = params.get('email');
  const endpoint = 'https://api.drewwebbai.com/submission?id='; // keep for future

  const $ = sel => document.querySelector(sel);
  const hello   = $('#hello');
  const context = $('#context');
  const tagsBox = $('#tags');

  function renderWelcome({ firstName, lastName, company, title, linkedin, email }) {
    const name = [firstName, lastName].filter(Boolean).join(' ');
    const who  = name || email || 'there';
    hello.innerHTML = `<h1>Welcome, ${who} ðŸ‘‹</h1>`;

    const parts = [];
    if (title)   parts.push(title);
    if (company) parts.push(company);
    context.textContent =
      parts.length ? `I pulled a few highlights relevant to ${parts.join(' @ ')}.` :
                     `I pulled a few highlights I think youâ€™ll care about.`;

    const tags = [];
    if (company) tags.push(company);
    if (title)   tags.push(title);
    if (linkedin)tags.push('LinkedIn');
    if (email)   tags.push(email);
    tagsBox.innerHTML = tags.map(t => `<span class="pill">${t}</span>`).join('');
  }

  async function load() {
    // Guest view
    if (isGuest) {
      hello.innerHTML = `<h1>Welcome, guest ðŸ‘‹</h1>`;
      context.textContent = "Hereâ€™s a quick tour of my work. If youâ€™d like a tailored view, introduce yourself on the previous page.";
      return;
    }

    // Simple path: form.js redirected with ?name=&email=
    if (nameQP || emailQP) {
      const [firstName, ...rest] = (nameQP || '').split(' ');
      const lastName = rest.join(' ');
      renderWelcome({
        firstName: firstName || '',
        lastName:  lastName  || '',
        company:   '', title: '', linkedin: '', email: emailQP || ''
      });
      return;
    }

    // Advanced path: if you later store submissions & redirect with ?id=...
    if (id) {
      try {
        const res = await fetch(endpoint + encodeURIComponent(id));
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'not_found');
        renderWelcome(data.data);
        return;
      } catch (e) {
        // fall through to generic
      }
    }

    // Generic fallback
    hello.innerHTML = `<h1>Welcome!</h1>`;
    context.textContent = "I couldnâ€™t load the tailored view, but here are some highlights.";
  }

  load();
</script>
